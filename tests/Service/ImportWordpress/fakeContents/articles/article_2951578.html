
<p>Dans cet exemple nous allons prendre le cas concret d&rsquo;une interface simple qui comprend des √©l√©ments multiples. <br>Nous avons choisis d&rsquo;utiliser une table ¬´¬†Projets¬†¬ª dans laquelle nous allons affecter des documents. <br>Donc pour un projet, nous pouvons affecter plusieurs documents. Et pour faciliter l&rsquo;administration, nous allons faire en sorte de pouvoir g√©rer notre interface imbriqu√©e directement dans la vue d&rsquo;√©dition de notre projet.<br><br>Il nous faut cr√©er le sch√©ma. <br>Au pr√©alable on importe notre sch√©ma actuel dans MysqlWorbench avec la fonction ¬´¬†Database/reverse engineer¬†¬ª. Ce qui nous permettra d&rsquo;avoir les tables par d√©faut de Sonata puisque nous allons jouer avec les m√©dias.<br></p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><a href="https://www.partitech.com/wp-content/uploads/2022/11/image-2.png"><img decoding="async" loading="lazy" width="541" height="426" src="https://www.partitech.com/wp-content/uploads/2022/11/image-2.png" alt="" class="wp-image-2039" srcset="https://www.partitech.com/wp-content/uploads/2022/11/image-2.png 541w, https://www.partitech.com/wp-content/uploads/2022/11/image-2-300x236.png 300w" sizes="(max-width: 541px) 100vw, 541px" /></a></figure></div>


<p><br><br>Avec MysqlWorbench on choisit une relation 1-&gt;N entre notre table ¬´¬†projets¬†¬ª et la table ¬´¬†<strong>projets_medias</strong>¬†¬ª et ensuite une relation N-&gt;1 entre la table ¬´¬†<strong>projets_medias</strong>¬†¬ª et la table ¬´¬†<strong>media__media</strong>¬´¬†.<br><br>1-&gt;N = OneToMany <br>N-&gt;1 = ManyToOne</p>



<p><strong>La subtilit√© consiste √† mettre un id auto incr√©ment par d√©faut dans notre table de liaison et de ne pas mettre nos cl√©s √©trang√®res en primary.</strong></p>



<p>√áa nous donne ceci :<br></p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><a href="https://www.partitech.com/wp-content/uploads/2022/11/image-6.png"><img decoding="async" loading="lazy" width="541" height="296" src="https://www.partitech.com/wp-content/uploads/2022/11/image-6.png" alt="" class="wp-image-2049" srcset="https://www.partitech.com/wp-content/uploads/2022/11/image-6.png 541w, https://www.partitech.com/wp-content/uploads/2022/11/image-6-300x164.png 300w" sizes="(max-width: 541px) 100vw, 541px" /></a></figure></div>


<p><strong>projet_id</strong> contiendra l&rsquo;id de la table<strong> projets</strong> et <strong>media_id</strong> contiendra l&rsquo;id de la table  <strong>media__media</strong>.<br>On rajoute un champ ordre mais on peut rajouter autant de champs que l&rsquo;on souhaite. Car nous allons voir comment g√©rer l&rsquo;ensemble du formulaire d&rsquo;√©dition des √©l√©ments de projets_medias.</p>



<p>Dans MysqlWorbench, on choisit ¬´¬†Forward/reverse engineer¬†¬ª pour pousser notre sch√©ma dans mysql.<br><br>On fait un dernier tour de passe/passe avec les commandes de Symfony pour g√©n√©rer nos entit√©s et nos interfaces d&rsquo;admin par d√©faut.</p>



<pre class="wp-block-code"><code lang="bash" class="language-bash">bin/console doctrine:mapping:import "App\Entity" annotation --path=src/Entity
bin/console make:entity --regenerate App
bin/console make:sonata:admin App/Entity/Projets
bin/console make:sonata:admin App/Entity/ProjetsMedias</code></pre>



<p>C&rsquo;est magique mais incomplet. Il nous faut corriger les relations dans nos 2 entit√©s.<br>Nous allons d√©j√† d√©finir les propri√©t√©s d‚Äôacc√®s dans les deux sens.</p>



<p>Pour l&rsquo;entit√© App\Entity\Projets ce sera la propri√©t√© <strong>documents</strong>, avec les accesseurs <strong>addDocument</strong> et <strong>removeDocument</strong></p>



<pre title="App\Entity\Projets" class="wp-block-code"><code lang="php" class="language-php line-numbers">
use Doctrine\Common\Collections\Collection;
...
...
private $documents;

public function getDocuments(): Collection
{

    return $this-&gt;documents;
}

public function addDocument(ProjetsMedias $document): self
{
    if (!$this-&gt;documents-&gt;contains($document)) {
        $this-&gt;documents[] = $document;
        $document-&gt;setProjets($this);
    }

    return $this;
}

public function removeDocument(ProjetsMedias $document): self
{
    if ($this-&gt;documents-&gt;removeElement($document)) {
        // set the owning side to null (unless already changed)
        if ($document-&gt;getProjets() === $this) {
            $document-&gt;setProjets(null);
        }
    }

    return $this;
}</code></pre>



<p><br>Pour l&rsquo;entit√© <strong><em>App\Entity\ProjetsMedias</em></strong> ce sera la propri√©t√© <strong>projets</strong>, avec les accesseurs <strong>getProjets()</strong> et <strong>setProjets()</strong>.</p>



<pre title="App\Entity\ProjetsMedias" class="wp-block-code"><code lang="php" class="language-php line-numbers">private $projets;

public function getProjets(): ?Projets
{
    return $this-&gt;projets;
}

public function setProjets(?Projets $projets): self
{
    $this-&gt;projets = $projets;
    return $this;
}</code></pre>



<p>Concentrons nous sur la configuration de la relation Projets-&gt;ProjetsMedias car c&rsquo;est l√† que tout se joue.</p>



<pre title="\App\Entity\Projets::$documents" class="wp-block-code"><code lang="php" class="language-php line-numbers">/**
 * @var \Doctrine\Common\Collections\Collection
 *
 * @ORM\OneToMany(targetEntity="App\Entity\ProjetsMedias", mappedBy="projets", cascade={"persist", "remove" })
 * @ORM\JoinTable(name="projets_medias",
 *   joinColumns={
 *     @ORM\JoinColumn(name="projets_id", referencedColumnName="id")
 *   }
 * )
 */
private $documents;</code></pre>



<p>La propri√©t√© targetEntity de notre OnToMany doit pointer sur l&rsquo;entit√© de notre table qui contient la liste des documents et on doit lui donner la propri√©t√© de notre relation ManyToOne de cette entit√©.<br>Donc ici c&rsquo;est  \App\Entity\ProjetsMedias qui a une propri√©t√© <strong>projets</strong>. On lui donne ensuite le nom de la table mysql qu&rsquo;il doit joindre : <strong>projets_media</strong>. JoinColumn d√©finit le nom du champ de la table jointe qui contiendra nos cl√©s primaires de projets, soit la valeur de notre propri√©t√© <strong>id</strong>, qui doit √™tre stock√©e dans la table <strong>projets_id</strong> de <strong>projets_media</strong>.</p>



<p>Ensuite nous configurons notre relation dans ProjetsMedia.</p>



<pre title="\App\Entity\ProjetsMedias::$projets" class="wp-block-code"><code lang="php" class="language-php line-numbers">/**
 * @var \Projets
 *
 * @ORM\ManyToOne(targetEntity="Projets",inversedBy="documents")
 * @ORM\JoinColumns({
 *   @ORM\JoinColumn(name="projets_id", referencedColumnName="id")
 * })
 */
private $projets;

public function getProjets(): ?Projets
{
    return $this-&gt;projets;
}

public function setProjets(?Projets $projets): self
{
    $this-&gt;projets = $projets;

    return $this;
}</code></pre>



<p>La propri√©t√© targetEntity de notre ManyToOne doit pointer sur l&rsquo;entit√© de notre table qui g√®re les projets et on doit lui donner la propri√©t√© de notre relation OneToMany de cette entit√©.<br>Donc ici c&rsquo;est <strong>Projets</strong> qui a une propri√©t√© <strong>documents</strong>.<br>On lui donne ensuite le champ de notre table courante (ProjetsMedia) qui stocke la clef primaire du projet. Donc <strong>id</strong> de la table <strong>projets</strong> qui est stock√©e dans <strong>projets_id</strong> de <strong>projets_media</strong><br></p>



<p>C‚Äôest ni plus ni moins que l‚Äôinverse de ce que l‚Äôon a configur√© pour notre d√©finition de <strong>\App\Entity\Projets::$documents</strong></p>



<p>Derni√®re √©tape, comme on a choisit de jouer avec des m√©dias, on doit configurer notre relation avec la m√©diath√®que de Sonata et configurer les accesseurs.</p>



<pre title="\App\Entity\ProjetsMedias::$mediaMedia" class="wp-block-code"><code lang="php" class="language-php line-numbers">use Sonata\MediaBundle\Model\MediaInterface;
...
...
/**
 * @var \MediaMedia
 *
 * @ORM\ManyToOne(targetEntity="App\Application\Sonata\MediaBundle\Entity\Media")
 * @ORM\JoinColumns({
 *   @ORM\JoinColumn(name="media_id", referencedColumnName="id")
 * })
 */
private $mediaMedia;

public function __toString(): string
{
    return $this-&gt;getMediaMedia();
}

public function getMediaMedia(): ?MediaInterface
{

    return $this-&gt;mediaMedia;
}

public function setMediaMedia(?MediaInterface $mediaMedia): self
{
    $this-&gt;mediaMedia = $mediaMedia;

    return $this;
}</code></pre>



<p>Idem que plus haut. On commence par donner l&rsquo;entit√© cible, ici ¬´¬†App\Application\Sonata\MediaBundle\Entity\Media¬†¬ª. Car c&rsquo;est l&rsquo;entit√© que nous avons √©tendue dans notre configuration du bundle Sonata/Media.</p>



<p>Dans sonata_media.yml nous avons ceci :</p>



<pre title="config\packages\sonata_media.yml" class="wp-block-code"><code lang="yaml" class="language-yaml line-numbers">sonata_media:
   class:
        media: App\Application\Sonata\MediaBundle\Entity\Media
        gallery: App\Application\Sonata\MediaBundle\Entity\Gallery
        gallery_item: App\Application\Sonata\MediaBundle\Entity\GalleryItem
        category: App\Application\Sonata\ClassificationBundle\Entity\SonataClassificationCategory
</code></pre>



<p>√áa semble √©vident mais si vous tombez sur cet article sans avoir toutes les bases il me parait judicieux de le rappeler. √áa pourrait en d√©bloquer plus d&rsquo;un üòâ</p>



<p>Ensuite JoinColumn d√©finit comment on enregistre la relation. Donc c&rsquo;est le champ <strong>media_id</strong> de notre table <strong>projets_media</strong> qui contiendra le champ id de notre table qui g√®re les m√©dias (<strong>media__media</strong>).</p>



<p>Il nous reste √† configurer le champs m√©dia de notre admin que nous avons g√©n√©r√© automatiquement plus haut (ProjetsMediasAdmin.php).<br>Pour g√©rer un champ m√©dia il faut juste utiliser le ModelListType de Sonata. Libre √† vous d&rsquo;activer les boutons optionnels ajout/edition/liste/delete.</p>



<pre title="\App\Admin\ProjetsMediasAdmin::configureFormFields" class="wp-block-code"><code lang="php" class="language-php line-numbers">use Sonata\AdminBundle\Form\Type\ModelListType;
...
...
protected function configureFormFields(FormMapper $form): void
{
    $form
        -&gt;add('projets')
        -&gt;add('mediaMedia', ModelListType::class, [
            'required' =&gt; false,
            'btn_add'=&gt;true,
            'btn_edit'=&gt;false,
            'btn_list'=&gt;false,
            'btn_delete'=&gt;false,
        ])
        -&gt;add('ordre')
    ;
}</code></pre>



<p>Les relations sont maintenant compl√®tes. On peut v√©rifier que tout fonctionne en activant notre admin de ProjetsMedia.</p>



<p>Dans nos services la g√©n√©ration de nos interfaces nous a configur√© ceci :</p>



<pre title="config/services.yaml" class="wp-block-code"><code lang="yaml" class="language-yaml line-numbers">    admin.projets:
        class: App\Admin\ProjetsAdmin
        tags:
            - { name: sonata.admin, model_class: App\Entity\Projets, controller: App\Controller\ProjetsAdminController, manager_type: orm, group: admin, label: Projets }

    admin.projets_medias:
        class: App\Admin\ProjetsMediasAdmin
        tags:
            - { name: sonata.admin, model_class: App\Entity\ProjetsMedias, controller: App\Controller\ProjetsMediasAdminController, manager_type: orm, group: admin, label: ProjetsMedias }
        arguments: [~, App\Entity\ProjetsMediasAdmin, ~]</code></pre>



<p>On peut donc aller directement sur notre interface pour voir si √ßa fonctionne.</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><a href="https://www.partitech.com/wp-content/uploads/2022/11/image-4.png"><img decoding="async" loading="lazy" width="793" height="409" src="https://www.partitech.com/wp-content/uploads/2022/11/image-4.png" alt="" class="wp-image-2046" srcset="https://www.partitech.com/wp-content/uploads/2022/11/image-4.png 793w, https://www.partitech.com/wp-content/uploads/2022/11/image-4-300x155.png 300w, https://www.partitech.com/wp-content/uploads/2022/11/image-4-768x396.png 768w, https://www.partitech.com/wp-content/uploads/2022/11/image-4-550x284.png 550w" sizes="(max-width: 793px) 100vw, 793px" /></a></figure></div>


<p>Mais ce qui nous int√©resse c&rsquo;est d&rsquo;avoir cette interface de gestion directement dans notre gestion de Projets.</p>



<p>Et pour cela nous allons utiliser les <strong>CollectionType</strong> de Sonata. <br>Nous ajoutons √† notre admin g√©n√©r√© automatiquement, dans la m√©thode qui g√®re la configuration de formulaire d&rsquo;√©dition (configureFormFields), un champ <strong>documents</strong> qui aura comme type <strong>CollectionType</strong> avec sa configuration, et chose la plus importante, on ajoute le param√®tre <strong>admin_code</strong> qui pointe sur le nom du service de notre admin de <strong>projets_media</strong>.</p>



<pre title="\App\Admin\ProjetsAdmin::configureFormFields" class="wp-block-code"><code lang="php" class="language-php line-numbers">$form-&gt;add('documents', \Sonata\Form\Type\CollectionType::class,
    [
        'required' =&gt; false,
        'by_reference' =&gt; false,
        'label'=&gt; false],
    [
        'edit' =&gt; 'inline',
        'inline' =&gt; 'table',
        'sortable' =&gt; 'position',
        'link_parameters' =&gt; [
            'context' =&gt; 'default',
            'provider' =&gt; 'sonata.media.provider.file',
            'hide_context' =&gt; true
        ],
        'admin_code' =&gt; 'admin.projets_medias'
    ]
);</code></pre>



<p>Accessoirement, dans <strong>\App\Admin\ProjetsMediasAdmin</strong>, on supprime notre champ <strong>projets</strong> puisque la valeur sera renseign√©e automatiquement lorsque l&rsquo;admin sera imbriqu√© dans projets.</p>



<pre title="\App\Admin\ProjetsMediasAdmin " class="wp-block-code"><code lang="php" class="language-php line-numbers">protected function configureFormFields(FormMapper $form): void
{
    $form
        //-&gt;add('projets')
        -&gt;add('mediaMedia', \Sonata\AdminBundle\Form\Type\ModelListType::class, [
            'required' =&gt; false,
            'btn_add'=&gt;true,
            'btn_edit'=&gt;false,
            'btn_list'=&gt;false,
            'btn_delete'=&gt;false,
        ])
        -&gt;add('ordre')
    ;
}</code></pre>



<p>Et la magie op√®re. On peut maintenant ajouter/supprimer des m√©dias directement dans notre interface.</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><a href="https://www.partitech.com/wp-content/uploads/2022/11/image-5.png"><img decoding="async" loading="lazy" width="856" height="840" src="https://www.partitech.com/wp-content/uploads/2022/11/image-5.png" alt="" class="wp-image-2047" srcset="https://www.partitech.com/wp-content/uploads/2022/11/image-5.png 856w, https://www.partitech.com/wp-content/uploads/2022/11/image-5-300x294.png 300w, https://www.partitech.com/wp-content/uploads/2022/11/image-5-768x754.png 768w, https://www.partitech.com/wp-content/uploads/2022/11/image-5-800x785.png 800w, https://www.partitech.com/wp-content/uploads/2022/11/image-5-550x540.png 550w, https://www.partitech.com/wp-content/uploads/2022/11/image-5-611x600.png 611w" sizes="(max-width: 856px) 100vw, 856px" /></a></figure></div>


<p>Mais ce n&rsquo;est pas tout √† fait termin√©. On a un champ pour d√©terminer l&rsquo;ordre de notre affichage. Il nous faut juste configurer l&rsquo;admin de <strong>ProjetsMedia</strong> pour modifier le type du champs <strong>ordre</strong>.</p>



<pre title="\App\Admin\ProjetsMediasAdmin::configureFormFields" class="wp-block-code"><code lang="php" class="language-php line-numbers">use Symfony\Component\Form\Extension\Core\Type\HiddenType;
...
...
protected function configureFormFields(FormMapper $form): void
{
    $form
        //-&gt;add('projets')
        -&gt;add('mediaMedia', ModelListType::class, [
            'required' =&gt; false,
            'btn_add'=&gt;true,
            'btn_edit'=&gt;false,
            'btn_list'=&gt;false,
            'btn_delete'=&gt;false,
        ])
        -&gt;add('ordre', HiddenType::class)
    ;
}</code></pre>



<p>Ensuite on configure notre Collection dans Projets, pour que le param√®tre sortable pointe sur notre bon champ.</p>



<pre title="\App\Admin\ProjetsAdmin::configureFormFields" class="wp-block-code"><code lang="php" class="language-php line-numbers">$form-&gt;add('documents', \Sonata\Form\Type\CollectionType::class,
    [
        'required' =&gt; false,
        'by_reference' =&gt; false,
        'label'=&gt; false],
    [
        'edit' =&gt; 'inline',
        'inline' =&gt; 'table',
        'sortable' =&gt; 'ordre',
        'link_parameters' =&gt; [
            'context' =&gt; 'default',
            'provider' =&gt; 'sonata.media.provider.file',
            'hide_context' =&gt; true
        ],
        'admin_code' =&gt; 'admin.projets_medias'
    ]
);</code></pre>



<p>Et dernier point, on modifie notre relation Projets-&gt;ProjetsMedia pour donner l&rsquo;ordre souhait√©.</p>



<pre title="\App\Entity\Projets::$documents" class="wp-block-code"><code lang="php" class="language-php line-numbers">/**
 * @var \Doctrine\Common\Collections\Collection
 *
 * @ORM\OneToMany(targetEntity="App\Entity\ProjetsMedias", mappedBy="projets", cascade={"persist", "remove" })
 * @ORM\JoinTable(name="projets_medias",
 *   joinColumns={
 *     @ORM\JoinColumn(name="projets_id", referencedColumnName="id")
 *   }
 * )
 * @ORM\OrderBy({"ordre" = "ASC"})
 */
private Collection $documents;</code></pre>



<p>Notre collection peut maintenant √™tre ordonn√©e par simple drag&rsquo;n drop.</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><a href="https://www.partitech.com/wp-content/uploads/2022/11/Selection_262.png"><img decoding="async" loading="lazy" width="736" height="390" src="https://www.partitech.com/wp-content/uploads/2022/11/Selection_262.png" alt="" class="wp-image-2062" srcset="https://www.partitech.com/wp-content/uploads/2022/11/Selection_262.png 736w, https://www.partitech.com/wp-content/uploads/2022/11/Selection_262-300x159.png 300w, https://www.partitech.com/wp-content/uploads/2022/11/Selection_262-550x291.png 550w" sizes="(max-width: 736px) 100vw, 736px" /></a></figure></div>